\chapter{Digital Repeater Routing Behavior}

When the AX.25 networks were originally built in the 1980s,
one of the fundamental design assumptions was that every node was 
physically static in the network.
Digipeaters were installed on top of high buildings or mountain tops, 
and client nodes were modems connected to bulky video terminals or desktop PCs.
When two stations wanted to exchange packets,
the operators had to manually construct an explicit list of digipeaters to use
to deliver packets to the other station.
Should a station move to a new area, 
the operator would need to discover new near-by digipeaters and manually construct
routing paths using them.

One of the design goals of APRS has been to support mobile nodes,
so this requirement to pre-facto be aware of the
local infrastructure is unacceptable.
The solution was to categorize digipeaters into a small number of ``aliases"
such that a digipeater would respond to both its specific callsign
and to any of its aliases.
A mobile station expecting to move throughout the APRS network
could then construct it's routing paths purely out of digipeater aliases
and use the network infrastructure despite not knowing
each digipeater's callsign or location.

As APRS has grown from an experimental network
to one that covers much of the country,
it has adopted and discarded multiple sets of digipeater aliases
and sets of expectations as to each node's behavior regarding those aliases,
without making it clear that the previous behavior has been deprecated.
The rest of this chapter will walk through the history
of the basic set of routing aliases,
followed by an overview of possible digipeater behaviors.

More than anything else, this chapter is going to highlight
how ambiguous the APRS specification is in regards to digipeater behavior.
Most of the aliases discussed in the original APRS protocol specification
have been subsequently deprecated,
without the APRS specification being amended to indicate as such.
The APRS specification also failed to have a detailed discussion
on digipeater behavior,
so many different interpretations and ideas have been developed, which has
created several divergent schools of thought on what behavior is best.
Writing a definitive analysis on digipeater behavior is a large undertaking
that warrants further consideration beyond what is possible in this paper.

\section{RELAY,WIDE}

The original conception of APRS included several aliases, but the most important were RELAY
and WIDE. Digipeaters were divided into two categories depending on if they were high-level
(on the top of large towers, mountain tops, etc.) or low-level (primarily sub-40' home installs).

Low-level ``fill-in" digipeaters are needed to assist low-power moving trackers in reaching the
primary high-level digipeater network where it would be possible to be heard by other stations.
Without these fill-in repeaters, lower power beacons would be lost in the noise and never reach the 
network at large. Therefore, trackers that need this help would begin their routing path with RELAY.
The low-level digipeaters should only respond to the RELAY alias.

The high-level digipeaters that consist the major portion of the network coverage in terms of area
would respond to the alias of WIDE, in addition to the alias of RELAY, such that if a tracker got
lucky and happened to be decoded by one of the high level digis it wasn't punished for first requesting 
help from a lower-level digi.

This RELAY for low-level and both RELAY and WIDE alias for high-level digipeater concept worked well
because the existing packet hardware at the time natively supported configuring these aliases, but
became increasingly problematic as the APRS network grew and became higher density. Each digipeater
could not verify that they had already re-transmitted a beacon, so single packets would ``ping-pong" 
between digipeaters repeatedly until the entire path was finally consumed.

To solve this, a new digipeater behavior called deduplication (dedup) was implemented.
Each digi is expected to store a checksum of every recently heard or transmitted packet
based on the source callsign and packet contents for a limited amount of time. 
Should a digipeater receive a packet that is already in it's ``recently heard" database,
it should not digipeat it again, since that would likely cause additional network traffic
with little benefit.
It's important to note that the concept of a ``unique" packet is based \emph{solely} on the
source address and information field; APRS doesn't guarantee the destination address to be
an invariant, and the routing path will change on each hop.
The original design did not specify how long this dedup window should be,
but general consensus has settled on removing packets from the deduplication database after 30 seconds.

As an example, consider a small APRS network with three digipeaters: LOWDIG, HIGHA, and HIGHB.
LOWDIG is a low level digipeater that only responds to the RELAY alias, 
where HIGHA and HIGHB are both high-level digis and thus respond to both RELAY and WIDE.
Consider the following sequences of routing paths,
given various initial paths originating from a tracker and the assumption that packets are only
heard in the order listed.
\begin{itemize}
	\item Tracker transmits a packet with the path: WIDE
	\item HIGHA digipeats it as: WIDE*
	\item HIGHB drops the packet since it has no more ``unconsumed" hops.
\end{itemize}
To reach further out in the network, the user would append additional WIDE statements to their path:

\begin{itemize}
	\item Tracker: WIDE,WIDE
	\item HIGHA: WIDE*,WIDE
	\item HIGHB: WIDE*,WIDE*
\end{itemize}

If the tracker doesn't happen to reach any of the high-level digis, 
but does reach a low-level one, a path of WIDE,WIDE would do them no good:

\begin{itemize}
	\item Tracker: WIDE,WIDE
	\item LOWDIG drops the packet since the first path alias is not RELAY
\end{itemize}

Thus, a path of RELAY,WIDE would better serve the user,
since they could use two high-level digis should they happen to initially reach one:

\begin{itemize}
	\item Tracker: RELAY,WIDE
	\item HIGHA: RELAY*,WIDE
	\item HIGHB: RELAY*,WIDE*
\end{itemize}

While at the same time taking advantage of low-level digipeaters when needed:
\begin{itemize}
	\item Tracker: RELAY,WIDE
	\item LOWDIG: RELAY*,WIDE
	\item HIGHA: RELAY*,WIDE*
	\item HIGHB drops the packet due to no remaining hops
\end{itemize}

Even though neither high-level digipeater directly heard the tracker,
the low-level digipeater relayed the packet to HIGHA so at least one high-level
digipeater was able to repeat the packet for the rest of the network.

\section{WIDEn-N}

There was an inherent flaw in the RELAY,WIDE alias set
in that there was no way to summarize the requested path.
Every alias in the routing path lengthens the AX.25 frame by 7 octets,
so long paths such as ``RELAY,WIDE,WIDE,WIDE" were a burden on the network
by adding 28 octets to every packet.
WIDEn-N was developed as a method to condense multiple WIDE aliases into a single WIDEn alias.
Therefore, ``WIDE,WIDE,WIDE" could be rewritten as ``WIDE3-3," and each digipeater would
decrement the SSID instead of marking each WIDE alias as consumed until the entire WIDEn-N had
been consumed.

\begin{itemize}
	\item Tracker: WIDE3-3
	\item HIGHA decrements the non-zero SSID and transmits the packet as: WIDE3-2
	\item HIGHB interprets WIDE3-2 as having two hops remaining of the original three, 
		and consumes one: WIDE3-1
	\item HIGHC uses the final hop remaining and marks the entire WIDE3 as consumed: WIDE3*
\end{itemize}

This change only effects the WIDE alias and not RELAY,
since trackers MUST NOT use more than a single RELAY alias only at the beginning of their packet.
This is because it is assumed that high-level digipeaters have full transmit coverage over
the area of low-level digipeaters below them, so using a path such as WIDE,RELAY would
cause all of the low-level digipeaters below a high-level one to needlessly digipeat the packet.

\section{Deprecation of RELAY}

As the APRS network grew and the density of digipeaters increased in the late 1990s and early 2000s,
the deduplication behavior of each digi became increasingly important to the health of the network.
It became not unusual for digipeaters to be in range of three to five other digipeaters,
so without deduplication every packet could travel along an exponential number of
loops available in the densely connected mesh of digipeaters being built for the APRS network.

At this same time, APRS was becoming popular enough among amateur radio operators that
equipment manufacturers such as Kantronics, MFJ, and Kenwood started adding APRS-specific features
into their TNC products.
One of the most popular TNCs used for digipeater sites was the Kantronics KPC-3+,
which turned out to have an anomaly in it's 
version 9.0 firmware ROM regarding deduplication \cite{kpc3bugbulletin}.

The KPC-3+ correctly deduplicated packets routed via the WIDEn-N system,
but failed to correctly add to or consult the dedup database for single-hop
aliases such as RELAY.
This meant that popular routing paths such as ``RELAY,WIDE2-2" could result in
routing loops on the network:

\begin{itemize}
	\item Tracker: RELAY,WIDE2-2
	\item HIGHA doesn't add the packet to it's dedup database: RELAY*,WIDE2-2 
	\item HIGHB: RELAY*,WIDE2-1
	\item HIGHA hears the echo from HIGHB and thinks it hasn't heard the packet before: RELAY*,WIDE2*
\end{itemize}

Kantronics did release a patched ROM v9.1 in 2007, but to insufficient effect.
Getting access to digipeaters at remote radio sites is burdensome,
and physically replacing the 32 pin ROM chip inside the KPC-3+ 
with a \$40 replacement\footnote{Kantronics did offer free v9.1 ROM exchanges to 
any customers who had purchased their TNCs in the past two years} 
proved to be a sufficient barrier that many APRS digipeaters still
suffer from this defect.\footnote{It has been jokingly said that once a digipeater
	goes on the air, none of its settings will be changed until either the digipeater
or its owner dies}

Due to this growing population of digipeaters suffering from the Kantronics or other
misinterpretations of the RELAY,WIDE alias system, 
it was proposed that APRS switch to a purely WIDEn-N routing method. 
Instead of low-level digipeaters responding to RELAY,
they should now only process the alias WIDE1-1.
This means that a path such as ``RELAY,WIDE2-2" should now be rewritten as
``WIDE1-1,WIDE2-2." 
To digipeaters aware of this new interpretation, ``WIDE1-1,WIDE2-2" signifies 
requesting one low-level and two high-level hops.
To older digipeaters like the KPC-3+, it appears to be an odd way to request
three WIDE hops compared to ``WIDE3-3," 
yet the deduplication is still done correctly.

The issue with this replacement of RELAY with WIDE1-1 is that there is now
no way to correctly request a single high-level hop.
The solution was to allow trackers to use the alias of WIDE2-1 for single
high level hops.
This works, but now breaks the original meaning of the first number,
which stood for the originally requested number of hops.
When a digipeater receives a packet with a ``WIDE2-1" path, 
there is no way to definitively
tell if that alias represents a two hop request that has gone through one hop,
or a single high-level hop request that hasn't been processed yet.

Surprisingly, this single overload of WIDE2-1 for WIDE1-1 has rendered the
original meaning of the first digit almost meaningless.
Allowing this one exception to the originating station setting the two WIDEn-N
numbers the same, while not providing sufficient documentation
to make it abundantly clear that this is the only allowable exception,
has muddied the waters as to the actual meaning of the first number.
Taking a sample of traffic on the APRS-IS world-wide APRS backbone shows
0.7\% of APRS traffic requesting routing paths such as WIDE1-2 or WIDE2-3,
which should not ever exist.
A station beaconing with a path of WIDE2-3 indicates that they are requesting
two hops, and three of those hops are remaining, which is non-sense.\footnote{The
proper way to request three hops would be to use WIDE3-3.}
This demonstrates that users are clearly confused and that a
major institutional failure occurred in how the meaning of the WIDEn-N alias has
been presented.

\section{Minimum WIDEn-N Behavior}

APRS digipeaters are divided into two classes; high-level digipeaters and
low-level digipeaters, which dictates variations in their behavior.
High-level digipeaters form the major backbone of the APRS digipeater network
and are generally installed on the tops of mountains,
tall office buildings, and large towers.
Low-level digipeaters usually have their antennas less than 50 feet above ground
level, and cover a small subset of the wider coverage provided by the
nearest high-level digipeater.

Since each low-level digipeater's coverage area is a subset of the
nearest high-level digipeater's coverage, a low-level digi isn't needed
to repeat packets coming in from the high-level digipeater.
Low-level digipeaters are designed to solely act as ``boosters" to
help local low-power trackers be able to reach the nearest high-level digi.
Therefore, low-level digipeaters should only digipeat packets which
have ``WIDE1-1" as their first routing hop, since that indicates that
the user doesn't believe they can reach high-level digipeaters directly.

High-level digipeaters form the actual blanket coverage of APRS, and
should respond to any valid WIDEn-N alias which still contains unconsumed hops,
including WIDE1-1. This is because many digipeaters will only consume the first
unused alias in the path, so a low-power tracker that gets ``lucky" and manages to
reach a high-level digipeater while using a path such as ``WIDE1-1,WIDE2-2"
depends on high-level digipeaters responding to WIDE1-1.

Digipeater behavior includes several more caveats which don't involve the APRS
WIDEn-N routing alias,\footnote{Examples include the expectation of digipeaters
	to substitute their callsigns into routing paths as they consume aliases,
	and that they still must respond to their callsign as a routing hop in 
addition to the WIDEn-N alias.} 
so this section can't be considered a complete definition of a digipeater's behavior.

\section{Variations on Digipeater Behavior}

As previously mentioned, the failure of the APRS specification to provide
a comprehensive extension of digipeater behavior for APRS has caused
implementers to get creative with the details and extensions of
the basic behavior defined in the AX.25 specification.
Some of these variations include:
\begin{itemize}
	\item Should digipeaters replace used aliases with their callsign, and
		how should the last hop of multi-hop aliases be handled?\footnote{i.e.
		should ``WIDE3-1" become ``DIGIA*" or ``DIGIA*,WIDE3*"?}
	\item Preemptive digipeating, where digipeaters don't only consider the
		first unused alias, but continues to search the entire path
		until a match is found, and marks every skipped alias as used as well.
	\item Long path traps, where abusive WIDE paths such as WIDE7-7 are trapped
		and all or many requested hops are consumed by the first digipeater
		to prevent flooding extremely large areas.
	\item Direct-only digipeaters, where low-level digipeaters don't only respond
		to WIDE1-1, but only digipeat packets when they appear to have not
		been already digipeated by another digipeater.
	\item Viscous delay digipeaters, where packets are held for a number of
		seconds to see if they are otherwise re-transmitted by other digipeaters.
		If an echo of a packet is heard, it gets dropped instead of digipeated.
	\item Token bucket digipeaters, which refuse to digipeat stations which
		exceed a specified volume of network traffic.
\end{itemize}

While the implications of any single item on this list are seemingly small,
the countless permutations and inconsistencies seen deployed in the
world-wide APRS network causes the network to behave unpredictably and
give disappointing levels of service to its end-users.
Further work is needed to specify how much of a digipeater's behavior is
required versus optional, and how much latitude should be given to individual
digipeater operators for any of the optional features implemented.

